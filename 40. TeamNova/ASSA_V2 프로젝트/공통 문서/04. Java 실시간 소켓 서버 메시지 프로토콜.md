---
created: 2025-05-29T23:49
updated: 2025-05-30T00:01
version: 1
---

# 4. ASSA Java 실시간 소켓 서버 메시지 프로토콜 v1.0

## 1. 프로토콜 개요

### 1.1 기본 정보

- **통신 방식**: TCP Socket (Port 12345)
- **메시지 형식**: JSON
- **문자 인코딩**: UTF-8
- **연결 방식**: Persistent Connection
- **인증 방식**: JWT Token 기반

### 1.2 연결 플로우

```
1. 클라이언트 → 서버: Socket 연결
2. 클라이언트 → 서버: CONNECT 액션 (JWT 토큰 포함)
3. 서버 → 클라이언트: CONNECT_RESPONSE (인증 결과)
4. 실시간 메시지 교환
5. 클라이언트 → 서버: 연결 종료 또는 타임아웃
```

## 2. 공통 메시지 구조

### 2.1 기본 메시지 형식

```json
{
  "action": "ACTION_TYPE",
  "data": {
    // 액션별 데이터 구조
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "unique_sequence_id",
  "user_id": 123,
  "session_id": "session_unique_id"
}
```

### 2.2 필드 설명

- `action` (string, required): 수행할 액션 타입
- `data` (object, optional): 액션별 페이로드 데이터
- `timestamp` (string, required): ISO 8601 형식의 타임스탬프
- `seq_id` (string, required): 메시지 고유 식별자
- `user_id` (integer, optional): 사용자 ID (인증 후)
- `session_id` (string, optional): 세션 ID (서버 생성)

### 2.3 응답 메시지 구조

```json
{
  "action": "ACTION_RESPONSE",
  "success": true,
  "message": "성공 메시지",
  "data": {
    // 응답 데이터
  },
  "error_code": "ERROR_CODE",
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "original_sequence_id"
}
```

## 3. 인증 및 연결 관리

### 3.1 사용자 연결 (CONNECT)

**클라이언트 → 서버:**

```json
{
  "action": "CONNECT",
  "data": {
    "jwt_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "device_info": {
      "platform": "android",
      "app_version": "1.0.0",
      "device_id": "unique_device_id"
    }
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "connect_001"
}
```

**서버 → 클라이언트:**

```json
{
  "action": "CONNECT_RESPONSE",
  "success": true,
  "message": "연결이 성공적으로 설정되었습니다",
  "data": {
    "user_id": 123,
    "session_id": "session_abc123",
    "server_time": "2024-01-01T12:00:00.000Z",
    "reconnection_info": {
      "existing_rooms": [1, 2, 3],
      "unread_messages": 5
    }
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "connect_001"
}
```

**연결 실패 응답:**

```json
{
  "action": "CONNECT_RESPONSE",
  "success": false,
  "message": "인증에 실패했습니다",
  "error_code": "AUTH_FAILED",
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "connect_001"
}
```

### 3.2 연결 종료 (DISCONNECT)

**클라이언트 → 서버:**

```json
{
  "action": "DISCONNECT",
  "data": {
    "reason": "user_logout"
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "disconnect_001",
  "user_id": 123
}
```

## 4. 채팅방 관리

### 4.1 채팅방 생성 (CREATE_ROOM)

**클라이언트 → 서버:**

```json
{
  "action": "CREATE_ROOM",
  "data": {
    "name": "새 채팅방",
    "description": "채팅방 설명",
    "is_open": false,
    "max_participants": 50,
    "invited_user_ids": [456, 789]
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "create_room_001",
  "user_id": 123
}
```

**서버 → 클라이언트:**

```json
{
  "action": "CREATE_ROOM_RESPONSE",
  "success": true,
  "message": "채팅방이 생성되었습니다",
  "data": {
    "room_id": 100,
    "name": "새 채팅방",
    "description": "채팅방 설명",
    "host_user_id": 123,
    "participants": [
      {
        "user_id": 123,
        "nickname": "호스트닉네임",
        "role": "host"
      }
    ],
    "created_at": "2024-01-01T12:00:00.000Z"
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "create_room_001"
}
```

### 4.2 채팅방 참가 (JOIN_ROOM)

**클라이언트 → 서버:**

```json
{
  "action": "JOIN_ROOM",
  "data": {
    "room_id": 100
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "join_room_001",
  "user_id": 456
}
```

**서버 → 클라이언트:**

```json
{
  "action": "JOIN_ROOM_RESPONSE",
  "success": true,
  "message": "채팅방에 참가했습니다",
  "data": {
    "room_id": 100,
    "room_info": {
      "name": "새 채팅방",
      "description": "채팅방 설명",
      "host_user_id": 123,
      "participants_count": 2
    },
    "participants": [
      {
        "user_id": 123,
        "nickname": "호스트닉네임",
        "role": "host"
      },
      {
        "user_id": 456,
        "nickname": "참가자닉네임",
        "role": "member"
      }
    ],
    "recent_messages": []
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "join_room_001"
}
```

**채팅방 내 다른 사용자들에게 브로드캐스트:**

```json
{
  "action": "USER_JOINED",
  "data": {
    "room_id": 100,
    "user": {
      "user_id": 456,
      "nickname": "참가자닉네임",
      "role": "member"
    },
    "participants_count": 2
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "broadcast_001"
}
```

### 4.3 채팅방 퇴장 (EXIT_ROOM)

**클라이언트 → 서버:**

```json
{
  "action": "EXIT_ROOM",
  "data": {
    "room_id": 100
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "exit_room_001",
  "user_id": 456
}
```

**서버 → 클라이언트:**

```json
{
  "action": "EXIT_ROOM_RESPONSE",
  "success": true,
  "message": "채팅방에서 나갔습니다",
  "data": {
    "room_id": 100
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "exit_room_001"
}
```

### 4.4 채팅방 정보 조회 (ROOM_INFO)

**클라이언트 → 서버:**

```json
{
  "action": "ROOM_INFO",
  "data": {
    "room_id": 100
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "room_info_001",
  "user_id": 123
}
```

**서버 → 클라이언트:**

```json
{
  "action": "ROOM_INFO_RESPONSE",
  "success": true,
  "data": {
    "room_id": 100,
    "name": "새 채팅방",
    "description": "채팅방 설명",
    "is_open": false,
    "host_user_id": 123,
    "participants_count": 2,
    "max_participants": 50,
    "created_at": "2024-01-01T12:00:00.000Z",
    "participants": [
      {
        "user_id": 123,
        "nickname": "호스트닉네임",
        "role": "host",
        "joined_at": "2024-01-01T12:00:00.000Z"
      }
    ]
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "room_info_001"
}
```

## 5. 메시지 전송 및 수신

### 5.1 메시지 전송 (SEND_MESSAGE)

**클라이언트 → 서버:**

```json
{
  "action": "SEND_MESSAGE",
  "data": {
    "room_id": 100,
    "content": "안녕하세요!",
    "message_type": "text",
    "reply_to_message_id": null,
    "client_message_id": "client_msg_001"
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "send_msg_001",
  "user_id": 123
}
```

**서버 → 전송자:**

```json
{
  "action": "SEND_MESSAGE_RESPONSE",
  "success": true,
  "message": "메시지가 전송되었습니다",
  "data": {
    "message_id": 1001,
    "room_id": 100,
    "content": "안녕하세요!",
    "message_type": "text",
    "created_at": "2024-01-01T12:00:00.000Z",
    "client_message_id": "client_msg_001"
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "send_msg_001"
}
```

**서버 → 채팅방 참여자들 (브로드캐스트):**

```json
{
  "action": "NEW_MESSAGE",
  "data": {
    "message_id": 1001,
    "room_id": 100,
    "content": "안녕하세요!",
    "message_type": "text",
    "user": {
      "user_id": 123,
      "nickname": "발신자닉네임",
      "profile_image": "/storage/profiles/123.jpg"
    },
    "created_at": "2024-01-01T12:00:00.000Z",
    "reply_to_message_id": null
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "broadcast_msg_001"
}
```

### 5.2 이미지 메시지 전송

**클라이언트 → 서버:**

```json
{
  "action": "SEND_MESSAGE",
  "data": {
    "room_id": 100,
    "content": "",
    "message_type": "image",
    "file_info": {
      "file_path": "/storage/messages/image_001.jpg",
      "file_name": "photo.jpg",
      "file_size": 1024000,
      "mime_type": "image/jpeg"
    },
    "client_message_id": "client_img_001"
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "send_img_001",
  "user_id": 123
}
```

### 5.3 메시지 수신 확인 (CHECK_RECEIVE)

**클라이언트 → 서버:**

```json
{
  "action": "CHECK_RECEIVE",
  "data": {
    "room_id": 100,
    "message_ids": [1001, 1002, 1003]
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "check_receive_001",
  "user_id": 456
}
```

**서버 → 클라이언트:**

```json
{
  "action": "CHECK_RECEIVE_RESPONSE",
  "success": true,
  "data": {
    "room_id": 100,
    "received_messages": [1001, 1002],
    "failed_messages": [],
    "pending_messages": [
      {
        "message_id": 1004,
        "content": "새로운 메시지",
        "user": {
          "user_id": 789,
          "nickname": "다른사용자"
        },
        "created_at": "2024-01-01T12:01:00.000Z"
      }
    ]
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "check_receive_001"
}
```

## 6. 사용자 초대

### 6.1 사용자 초대 (INVITE)

**클라이언트 → 서버:**

```json
{
  "action": "INVITE",
  "data": {
    "room_id": 100,
    "invited_user_ids": [789, 101112]
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "invite_001",
  "user_id": 123
}
```

**서버 → 초대한 사용자:**

```json
{
  "action": "INVITE_RESPONSE",
  "success": true,
  "message": "사용자들이 초대되었습니다",
  "data": {
    "room_id": 100,
    "invited_users": [
      {
        "user_id": 789,
        "nickname": "초대된사용자1",
        "status": "invited"
      },
      {
        "user_id": 101112,
        "nickname": "초대된사용자2",
        "status": "offline"
      }
    ]
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "invite_001"
}
```

**서버 → 초대받은 사용자 (온라인인 경우):**

```json
{
  "action": "INVITATION_RECEIVED",
  "data": {
    "room_id": 100,
    "room_info": {
      "name": "새 채팅방",
      "description": "채팅방 설명",
      "participants_count": 2
    },
    "inviter": {
      "user_id": 123,
      "nickname": "초대한사용자",
      "profile_image": "/storage/profiles/123.jpg"
    }
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "invitation_001"
}
```

## 7. WebRTC 영상통화

### 7.1 영상회의 방 생성 (CREATE_VIDEO_ROOM)

**클라이언트 → 서버:**

```json
{
  "action": "CREATE_VIDEO_ROOM",
  "data": {
    "chat_room_id": 100,
    "video_room_name": "영상회의",
    "max_participants": 10
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "create_video_001",
  "user_id": 123
}
```

**서버 → 클라이언트:**

```json
{
  "action": "CREATE_VIDEO_ROOM_RESPONSE",
  "success": true,
  "message": "영상회의 방이 생성되었습니다",
  "data": {
    "video_room_id": 200,
    "video_room_name": "영상회의",
    "chat_room_id": 100,
    "host_user_id": 123,
    "participants": [],
    "max_participants": 10,
    "created_at": "2024-01-01T12:00:00.000Z"
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "create_video_001"
}
```

### 7.2 영상회의 참가 (JOIN_VIDEO_ROOM)

**클라이언트 → 서버:**

```json
{
  "action": "JOIN_VIDEO_ROOM",
  "data": {
    "video_room_id": 200
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "join_video_001",
  "user_id": 456
}
```

**서버 → 참가자:**

```json
{
  "action": "JOIN_VIDEO_ROOM_RESPONSE",
  "success": true,
  "message": "영상회의에 참가했습니다",
  "data": {
    "video_room_id": 200,
    "participants": [
      {
        "user_id": 123,
        "nickname": "호스트닉네임",
        "role": "host",
        "media_status": {
          "audio_enabled": true,
          "video_enabled": true
        }
      },
      {
        "user_id": 456,
        "nickname": "참가자닉네임",
        "role": "participant",
        "media_status": {
          "audio_enabled": true,
          "video_enabled": true
        }
      }
    ]
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "join_video_001"
}
```

### 7.3 SDP 교환 (SDP)

**클라이언트 → 서버:**

```json
{
  "action": "SDP",
  "data": {
    "video_room_id": 200,
    "target_user_id": 456,
    "sdp_type": "offer",
    "sdp_data": "v=0\r\no=- 123456789 123456789 IN IP4 192.168.1.1\r\n..."
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "sdp_001",
  "user_id": 123
}
```

**서버 → 대상 사용자:**

```json
{
  "action": "SDP",
  "data": {
    "video_room_id": 200,
    "sender_user_id": 123,
    "sdp_type": "offer",
    "sdp_data": "v=0\r\no=- 123456789 123456789 IN IP4 192.168.1.1\r\n..."
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "sdp_relay_001"
}
```

### 7.4 ICE Candidate 교환 (ICE_CANDIDATE)

**클라이언트 → 서버:**

```json
{
  "action": "ICE_CANDIDATE",
  "data": {
    "video_room_id": 200,
    "target_user_id": 456,
    "candidate": "candidate:1 1 UDP 2130706431 192.168.1.1 54400 typ host",
    "sdp_mid": "0",
    "sdp_mline_index": 0
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "ice_001",
  "user_id": 123
}
```

### 7.5 미디어 상태 변경 (MEDIA_STATUS)

**클라이언트 → 서버:**

```json
{
  "action": "MEDIA_STATUS",
  "data": {
    "video_room_id": 200,
    "audio_enabled": false,
    "video_enabled": true
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "media_status_001",
  "user_id": 123
}
```

**서버 → 다른 참가자들:**

```json
{
  "action": "PARTICIPANT_MEDIA_STATUS",
  "data": {
    "video_room_id": 200,
    "user_id": 123,
    "nickname": "호스트닉네임",
    "audio_enabled": false,
    "video_enabled": true
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "media_broadcast_001"
}
```

### 7.6 영상회의 퇴장 (EXIT_VIDEO_ROOM)

**클라이언트 → 서버:**

```json
{
  "action": "EXIT_VIDEO_ROOM",
  "data": {
    "video_room_id": 200
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "exit_video_001",
  "user_id": 456
}
```

### 7.7 영상회의 참가자 조회 (GET_VIDEO_ROOM_PARTICIPANT)

**클라이언트 → 서버:**

```json
{
  "action": "GET_VIDEO_ROOM_PARTICIPANT",
  "data": {
    "video_room_id": 200
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "get_participants_001",
  "user_id": 123
}
```

## 8. 시스템 메시지

### 8.1 서버 공지 (SERVER_ANNOUNCEMENT)

**서버 → 클라이언트 (브로드캐스트):**

```json
{
  "action": "SERVER_ANNOUNCEMENT",
  "data": {
    "title": "서버 점검 안내",
    "message": "오늘 밤 12시부터 1시간 동안 서버 점검이 있습니다",
    "priority": "high",
    "announcement_type": "maintenance"
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "announcement_001"
}
```

### 8.2 연결 상태 확인 (PING/PONG)

**서버 → 클라이언트:**

```json
{
  "action": "PING",
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "ping_001"
}
```

**클라이언트 → 서버:**

```json
{
  "action": "PONG",
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "ping_001"
}
```

## 9. 에러 처리

### 9.1 에러 응답 형식

```json
{
  "action": "ERROR",
  "success": false,
  "message": "에러 메시지",
  "error_code": "ERROR_CODE",
  "data": {
    "original_action": "SEND_MESSAGE",
    "error_details": "상세 에러 정보"
  },
  "timestamp": "2024-01-01T12:00:00.000Z",
  "seq_id": "original_sequence_id"
}
```

### 9.2 주요 에러 코드

- `AUTH_FAILED`: 인증 실패
- `INVALID_TOKEN`: 유효하지 않은 토큰
- `ROOM_NOT_FOUND`: 채팅방을 찾을 수 없음
- `PERMISSION_DENIED`: 권한 없음
- `ROOM_FULL`: 채팅방 인원 초과
- `USER_NOT_IN_ROOM`: 사용자가 채팅방에 없음
- `MESSAGE_TOO_LONG`: 메시지가 너무 김
- `INVALID_MESSAGE_TYPE`: 지원하지 않는 메시지 타입
- `FILE_UPLOAD_FAILED`: 파일 업로드 실패
- `VIDEO_ROOM_NOT_FOUND`: 영상회의 방을 찾을 수 없음
- `MAX_PARTICIPANTS_REACHED`: 최대 참가자 수 초과

## 10. 성능 및 제한사항

### 10.1 메시지 크기 제한

- **텍스트 메시지**: 최대 5,000자
- **전체 JSON 메시지**: 최대 1MB
- **이미지 파일**: 최대 10MB
- **동시 연결**: 서버당 최대 1,000명

### 10.2 타임아웃 설정

- **연결 타임아웃**: 30초
- **메시지 응답 타임아웃**: 10초
- **PING 간격**: 30초
- **연결 유지**: PONG 미수신 시 60초 후 연결 해제

### 10.3 재연결 정책

- **자동 재연결**: 연결 끊어짐 시 최대 3회 시도
- **백오프 전략**: 1초, 2초, 4초 간격으로 재시도
- **세션 복구**: 재연결 시 이전 세션 정보 복구

---

본 프로토콜은 ASSA Java 실시간 소켓 서버와 클라이언트 간의 모든 통신 규약을 정의하며, 모든 개발팀이 동일한 프로토콜을 사용해야 합니다.
